<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="assets/img/icon.png"/>
    <link rel="stylesheet" href="assets/css/style.css">
    <title>Doadores cadastrados</title>
    <script>
        const token = localStorage.getItem('token');      
        if (!token) {
          window.location.href = 'index.html';
        }
    </script>

</head>
<body>
    <div class="tabela">

        <div class="close-container">
            <div class="close-page" onclick="sair()">
                <img src="assets/img/logout-icon.png" alt="Fechar p√°gina">
            </div>
        </div>

        <div class="title">
            <h1>Doadores cadastrados</h1>
        </div>

        <!-- Estrutura da tabela -->
        <div class="tabela-container">
            <input type="text" id="filtro" placeholder="Filtrar">
            <span class="iconeFiltro" onclick="aplicarFiltro('üëç')" >üëç</span>
            <span class="iconeFiltro" onclick="aplicarFiltro('üëé')" >üëé</span>
            <span class="iconeFiltro" onclick="aplicarFiltro('')" >üö´</span>
            <table id="tabelaDoadores">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Endere√ßo</th>
                        <th>Celular</th>
                        <th>Data de Nascimento</th>
                        <th>CPF</th>
                        <th>Tipo Sangu√≠neo</th>
                        <th>G√™nero</th>
                        <th>Idade</th>
                        <th>Data da Doa√ß√£o</th>
                        <th>Protocolo</th>
                        <th>Pr√≥xima Doa√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dados da tabela ser√£o inseridos aqui dinamicamente -->
                </tbody>
            </table>
        </div>

        <!-- Bot√£o para voltar para a p√°gina de cadastro -->
        <div class="botao-cadastro">
            <button type="button" onclick="window.location.href='cadastro.html'">Cadastro</button>
        </div>

        <script>

            // Fun√ß√£o para carregar dados do servidor e atualizar a tabela

            async function carregarDados() {
                try {
                    const token = localStorage.getItem('token');

                    // Verifica se o token est√° presente
                    if (!token) {
                        window.location.href = 'index.html';                        
                    }

                    // Define os cabe√ßalhos da requisi√ß√£o com o token de autoriza√ß√£o
                    const headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` // Inclui o token no cabe√ßalho de autoriza√ß√£o
                    };

                    // Faz a solicita√ß√£o fetch com os cabe√ßalhos definidos
                    fetch('/api/read', {
                        method: 'GET',
                        headers: headers
                    })
                    .then(response => {
                        if (response.status === 403) {
                            // Token inv√°lido, remover do localStorage e redirecionar para a p√°gina index.html
                            localStorage.removeItem('token');
                            window.location.href = 'index.html';
                            throw new Error('Token inv√°lido');
                        }
                        return response.json();
                    })
                    .then(data => {
                        const dados = data;
                        
                        // Limpa a tabela
                        document.getElementById('tabelaDoadores').getElementsByTagName('tbody')[0].innerHTML = "";

                        // Popula a tabela 
                        dados.forEach((doador) => {

                            const tabelaDoadores = document.getElementById('tabelaDoadores');
                            const tbody = tabelaDoadores.getElementsByTagName('tbody')[0];

                            const newRow = tbody.insertRow();

                            let dataDoacaoLocal;

                            // Usando setAttribute para adicionar o atributo ao <tr>
                            newRow.setAttribute('doador-id', doador._id);

                            // Formata a data antes de inserir na tabela
                            const dataNascimentoBr = dataBrasil(doador.dataNascimento);

                            if (doador.dataDoacao) {
                                const dataDoacaoUTC = new Date(doador.dataDoacao);
                                dataDoacaoLocal = dataDoacaoUTC.toISOString().split('T')[0];
                            };
                                        
                            const idadeDoador = calcularIdade(doador.dataNascimento);

                            var proximaDoacao = calcularProximaDoacao(doador.genero, idadeDoador, dataDoacaoLocal);

                            // Adiciona as colunas com os dados do doador
                            newRow.innerHTML = `<td class="nome">${doador.nome}</td>
                                                <td class="endereco">${doador.endereco}</td>
                                                <td class="celular">${doador.celular}</td>
                                                <td class="nascimento">${dataNascimentoBr}</td>
                                                <td><div class="CPF">******</div>
                                                    <span class="icone" onclick="toggleCPF('${doador._id}','${doador.cpf}')">&#128065;</span>
                                                </td>
                                                <td class="tipoSanguineo">${doador.tipoSanguineo}</td>
                                                <td class="genero">${doador.genero}</td>
                                                <td>${idadeDoador} Anos</td>
                                                <td><input type="date" name="dataDoacao" class="dataDoacao" required></td>
                                                <td><input type="text" oninput="this.value = this.value.replace(/[^A-Za-z0-9]/g, '')" name="protocolo" class="protocolo" required></td>
                                                <td class="prxDoacao" style="color: ${proximaDoacao.cor}">
                                                    ${dataBrasil(proximaDoacao.data)}
                                                    ${(proximaDoacao.cor === '#23962c') ? 'üëç' : ((proximaDoacao.cor === 'black') ? '' : 'üëé')}
                                                </td>`;

                            // Adiciona uma c√©lula para os bot√µes
                            const buttonsCell = newRow.insertCell();

                            // Cria uma div para os bot√µes e adiciona √† c√©lula
                            const buttonsDiv = document.createElement('div');
                            buttonsDiv.classList.add('buttons-container');
                            buttonsCell.appendChild(buttonsDiv);

                            // Adiciona os bot√µes na div
                            buttonsDiv.insertAdjacentHTML('beforeend', `<button onclick="agendarDoador('${doador._id}', '${doador.genero}', ${idadeDoador})">Incluir</button>`);
                            buttonsDiv.insertAdjacentHTML('beforeend', `<button onclick="editarDoador('${doador._id}', this)">Editar</button>`);
                            buttonsDiv.insertAdjacentHTML('beforeend', `<button onclick="excluirDoador('${doador._id}', '${doador.nome}')">Excluir</button>`);

                            // Verifica se a data de doa√ß√£o n√£o √© nula antes de preencher o campo de data
                            const inputDate = newRow.querySelector('.dataDoacao');
                            const inputProt = newRow.querySelector('.protocolo');
                            if(dataDoacaoLocal){
                                inputDate.value = dataDoacaoLocal;
                            };
                            if(doador.protocolo){
                                inputProt.value  = doador.protocolo;
                            };
                        });
                    })
                    .catch(error => {
                        console.error('Erro ao agendar doador:', error);
                    });
                    
                } catch (error) {
                    console.error('Erro ao carregar dados:', error);
                };
            }

            // Fun√ß√£o para lidar com inclus√£o da data da doa√ß√£o

            function agendarDoador(doadorId, genero, idade) {

                const token = localStorage.getItem('token');

                // Encontrar o input de data correspondente √† linha do doador com o id
                const inputDate = document.querySelector(`tr[doador-id="${doadorId}"] .dataDoacao`);
                const inputProt = document.querySelector(`tr[doador-id="${doadorId}"] .protocolo`);
                const dataDoacao = inputDate.value; 
                const protocolo = inputProt.value;

                if(dataDoacao && protocolo){
                    // Popup de confirma√ß√£o
                    const mensagem = 'Confirmar inclus√£o de dados?';

                    // Enviar dados p/ servidor
                    const confirmarAgendamento = function (confirmacao) {
                        if (confirmacao) {
                            const dados = {
                                doadorId: doadorId,
                                dataDoacao: dataDoacao,
                                protocolo: protocolo
                            };

                            console.log(dados);

                            // Define os cabe√ßalhos da requisi√ß√£o com o token de autoriza√ß√£o
                            const headers = {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}` // Inclui o token no cabe√ßalho de autoriza√ß√£o
                            };

                            fetch(`/api/edit`, {
                                method: 'POST',
                                headers: headers,
                                body: JSON.stringify(dados),
                            })
                            .then(response => {
                                if (response.status === 403) {
                                    // Token inv√°lido, remover do localStorage e redirecionar para a p√°gina index.html
                                    localStorage.removeItem('token');
                                    window.location.href = 'index.html';
                                    throw new Error('Token inv√°lido');
                                }
                                return response.json();
                            })
                            .then(data => {
                                console.log(data.message);
                                // Adicionar l√≥gica adicional, se necess√°rio
                            })
                            .catch(error => {
                                console.error('Erro ao agendar doador:', error);
                            });
                        }
                    };

                    exibirAlerta(mensagem, confirmarAgendamento);
                } else {
                    alert('Insira a data e o protocolo!');
                }
                
                // Atualizar a c√©lula 'P≈ïoxima Doa√ß√£o'
                const prxDoacao = document.querySelector(`tr[doador-id="${doadorId}"] .prxDoacao`);                
                prxDoacao.textContent = `${dataBrasil(calcularProximaDoacao(genero, idade, dataDoacao).data)}
                                            ${calcularProximaDoacao(genero, idade, dataDoacao).cor === '#23962c' ? ' üëç' : ' üëé'}`; 
                prxDoacao.style.color = `${calcularProximaDoacao(genero, idade, dataDoacao).cor}`;             
            }

            //Fun√ß√£o para calcular a pr√≥xima doa√ß√£o e cor da data

            function calcularProximaDoacao(genero, idadeDoador, dataDoacao){
                let proximaDoacao;
                let dataDoacaoObj = null;
              
                if (dataDoacao){
                    // Certificar de que dataDoacao √© um objeto Date
                    dataDoacaoObj = new Date(dataDoacao);
                }

                if (genero === 'Masculino' && idadeDoador <= 59 && dataDoacaoObj != null) {
                    proximaDoacao = new Date(dataDoacaoObj.getTime() + 61 * 24 * 60 * 1000 * 60); // 60 dias em milissegundos
                } else if (genero === 'Feminino' && idadeDoador <= 59 && dataDoacaoObj != null) {
                    proximaDoacao = new Date(dataDoacaoObj.getTime() + 91 * 24 * 60 * 1000 * 60); // 90 dias em milissegundos
                } else if (genero === 'Masculino' && idadeDoador > 59 && dataDoacaoObj != null) {
                    proximaDoacao = new Date(dataDoacaoObj.getTime() + 181 * 24 * 60 * 1000 * 60); // 180 dias em milissegundos
                } else if (genero === 'Feminino' && idadeDoador > 59 && dataDoacaoObj != null) {
                    proximaDoacao = new Date(dataDoacaoObj.getTime() + 211 * 24 * 60 * 1000 * 60); // 210 dias em milissegundos
                }

                let cor = 'black'; 
                let hoje = new Date();
                hoje = formatarData(hoje);

                if (proximaDoacao){
                    if (formatarData(proximaDoacao) <= hoje) {
                        cor = '#23962c';
                    } else {
                        cor = '#ff6868'; // mudar para vermelho se a data ainda n√£o chegou
                    }
                }                

                return { data: proximaDoacao ? formatarData(proximaDoacao) : 'a definir', cor: cor};
            };

            // Fun√ß√µes para lidar com a edi√ß√£o de doadores

            function editarDoador(doadorId, btnEditar) {
                const token = localStorage.getItem('token');

                const campos = ['nome', 'endereco', 'celular', 'nascimento', 'CPF', 'tipoSanguineo', 'genero'];
                let elementoAntes = {};

                // Salvar a refer√™ncia √† fun√ß√£o tornarClicavel para remo√ß√£o posterior
                const tornarClicavel = function () {
                    const valorOriginal = this.textContent;
                    this.innerHTML = ''; // Limpa o conte√∫do do elemento

                    const inputElement = document.createElement('input');
                    inputElement.value = valorOriginal;

                    // Verificar o tipo de elemento
                    if (this.classList.contains('celular') || this.classList.contains('CPF') ) {
                        inputElement.type = 'number';
                    } else if (this.classList.contains('nascimento')){
                        inputElement.type = 'date';
                    } else if (this.classList.contains('tipoSanguineo')){
                        inputElement.type = 'text';
                    } else {
                        inputElement.type = 'text'
                    }

                    this.appendChild(inputElement);

                    inputElement.addEventListener('blur', function () {
                        const novoValor = this.value;

                        // Remover o input e criar um novo elemento de texto
                        const textoElement = document.createElement('span');
                        textoElement.textContent = (inputElement.type === 'date') ? dataBrasil(novoValor) : novoValor;

                        // Substituir o input pelo elemento de texto
                        this.parentNode.replaceChild(textoElement, this);
                    });

                    inputElement.focus();
                };

                campos.forEach(function (campo) {
                    const elemento = document.querySelector(`tr[doador-id="${doadorId}"] .${campo}`);
                    elemento.style.cursor = 'pointer';
                    elemento.addEventListener('click', tornarClicavel);
                    elementoAntes[campo] = elemento.innerText;
                });

                console.log(elementoAntes);

                btnEditar.innerText = 'Salvar';
                btnEditar.style.backgroundColor = '#ff6868';

                btnEditar.onclick = function (){
                    if (btnEditar.innerText == 'Salvar'){
                        btnEditar.innerText = 'Editar';            
                        btnEditar.style.backgroundColor = '#c5c5c56c';

                        let dados = {
                            doadorId: doadorId,
                        };

                        // Remover o ouvinte de evento usando a mesma fun√ß√£o utilizada para adicionar
                        campos.forEach(function (campo) {
                            const elemento = document.querySelector(`tr[doador-id="${doadorId}"] .${campo}`);
                            elemento.removeEventListener('click', tornarClicavel);
                            elemento.style.cursor = 'text';

                            if (elemento.textContent !== elementoAntes[campo]){
                                dados[campo] = elemento.textContent;
                            }
                            
                        });

                        console.log(dados);

                        // Define os cabe√ßalhos da requisi√ß√£o com o token de autoriza√ß√£o
                        const headers = {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}` // Inclui o token no cabe√ßalho de autoriza√ß√£o
                            };

                        // Fa√ßa uma solicita√ß√£o AJAX para o servidor
                        fetch('/api/edit', {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify(dados),
                        })
                        .then(response => {
                                if (response.status === 403) {
                                    // Token inv√°lido, remover do localStorage e redirecionar para a p√°gina index.html
                                    localStorage.removeItem('token');
                                    window.location.href = 'index.html';
                                    throw new Error('Token inv√°lido');
                                }
                                return response.json();
                            })
                        .then(data => {
                            console.log('Sucesso:', data);
                            
                            alert('Doador atualizado!');
                        })
                        .catch((error) => {
                            console.error('Erro:', error);
                        });

                    } else{
                        btnEditar.innerText = 'Salvar';
                        btnEditar.style.backgroundColor = '#ff6868';
                        campos.forEach(function (campo) {
                            const elemento = document.querySelector(`tr[doador-id="${doadorId}"] .${campo}`);
                            elemento.style.cursor = 'pointer';
                            elemento.addEventListener('click', tornarClicavel);
                        });
                    };
                };
            }

            // Fun√ß√£o para lidar com a exclus√£o do doador

            function excluirDoador(doadorId, nome) {
                const token = localStorage.getItem('token');
                const mensagem = `Voc√™ realmente deseja excluir o doador:\n${nome} ?`;

                // Fun√ß√£o para lidar com a confirma√ß√£o
                const confirmarExclusao = function (confirmacao) {
                    if (confirmacao) {

                        // Define os cabe√ßalhos da requisi√ß√£o com o token de autoriza√ß√£o
                        const headers = {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}` // Inclui o token no cabe√ßalho de autoriza√ß√£o
                            };

                        fetch(`/api/delete`, {
                            method: 'DELETE',
                            headers: headers,
                            body: JSON.stringify({ doadorId }),
                        })
                        .then(response => {
                                if (response.status === 403) {
                                    // Token inv√°lido, remover do localStorage e redirecionar para a p√°gina index.html
                                    localStorage.removeItem('token');
                                    window.location.href = 'index.html';
                                    throw new Error('Token inv√°lido');
                                }
                                return response.json();
                            })
                        .then(data => {
                            console.log('Excluir doador com ID:', doadorId);
                            console.log(data.message);
                            // Atualizar a tabela escondendo a linha
                            const linha = document.querySelector(`tr[doador-id="${doadorId}"]`);
                            linha.style.display = "none";
                        })
                        .catch(error => {
                            console.error('Erro ao excluir doador:', error);
                        });                        
                    } else {
                        console.log('Exclus√£o cancelada pelo usu√°rio.');
                    }
                };

                // Exibir mensagem de confirma√ß√£o
                exibirAlerta(mensagem, confirmarExclusao);
            }

            // Fun√ß√£o para formatar a data no formato aaaa/mm/dd

            function formatarData(data) {
                const dataObj = new Date(data);
                const dia = String(dataObj.getDate()).padStart(2, '0');
                const mes = String(dataObj.getMonth() + 1).padStart(2, '0');
                const ano = dataObj.getFullYear();
                return `${ano}/${mes}/${dia}`;
            }
            
            // Fun√ß√£o para mudar o formato da data p/ DD/MM/AAAA

            function dataBrasil(dataString) {
                // Verifica se a data usa o caractere '-' como separador
                if (dataString.includes('-')) {
                    const partes = dataString.split('-');
                    if (partes.length === 3) {
                        // Verificar se h√° tr√™s partes (dia, m√™s, ano)
                        const data = `${partes[2]}/${partes[1]}/${partes[0]}`;
                        return data;
                    }
                } else if (dataString.includes('/')) {
                    // Se n√£o for '-', verifica se a data usa o caractere '/' como separador
                    const partes = dataString.split('/');
                    if (partes.length === 3) {
                        // Verificar se h√° tr√™s partes (dia, m√™s, ano)
                        const data = `${partes[2]}/${partes[1]}/${partes[0]}`;
                        return data;
                    }
                }

                // Se n√£o atender a nenhum dos formatos esperados, retorna 'a definir'
                return 'a definir';
            };

            // Fun√ß√£o para calcular a idade do Doador

            function calcularIdade(dataNascimento) {
                const hoje = new Date();
                const dataNascimentoObj = new Date(dataNascimento);

                let idade = hoje.getFullYear() - dataNascimentoObj.getFullYear();

                // Verifica se o anivers√°rio j√° ocorreu este ano
                const mesAtual = hoje.getMonth() + 1;
                const diaAtual = hoje.getDate();

                const aniversarioJaOcorreu = (mesAtual > dataNascimentoObj.getMonth() + 1) ||
                                            (mesAtual === dataNascimentoObj.getMonth() + 1 && diaAtual >= dataNascimentoObj.getDate());

                // Se o anivers√°rio ainda n√£o ocorreu este ano, subtrai 1 da idade
                if (!aniversarioJaOcorreu) {
                    idade--;
                };

                return idade;
            }

            // Fun√ß√£o para exibir e ocultar o CPF

            function toggleCPF(doadorId, doadorCPF) {
                const divCPF = document.querySelector(`tr[doador-id="${doadorId}"] .CPF`);
                let visivel = divCPF.dataset.visivel === 'true';

                if (!visivel) {
                    // Torna o CPF vis√≠vel
                    divCPF.innerHTML = `${doadorCPF}`;
                } else {
                    // Oculta o CPF
                    divCPF.innerHTML = `******`;
                };

                // Atualiza o dataset.visivel
                divCPF.dataset.visivel = visivel ? 'false' : 'true';
            }

            // Fun√ß√£o para Logout

            function sair() {
                exibirAlerta('Realmente deseja sair?', function (confirmacao) {
                    if (confirmacao) {
                    const token = localStorage.getItem('token');
                    localStorage.removeItem('token');
                    window.location.href = 'index.html';
                    }
                });
            }

            // Fun√ß√£o para exibir alertas customizados

            function exibirAlerta(mensagem, callback) {
                const overlay = document.getElementById('overlay');
                const mensagemElemento = document.getElementById('mensagemTexto');
                const botaoSim = document.getElementById('botaoSim');
                const botaoNao = document.getElementById('botaoNao');

                mensagemElemento.innerText = mensagem;
                botaoSim.onclick = function () {
                    overlay.style.display = 'none';
                    callback(true);
                };

                botaoNao.onclick = function () {
                    overlay.style.display = 'none';
                    callback(false);
                };

                overlay.style.display = 'flex';
            }
            
            // Chama a fun√ß√£o para carregar dados quando a p√°gina √© carregada
            window.onload = carregarDados;

        </script>

        <!--Caixa de Mensagens para Alertas -->
        <div id="overlay">
            <div id="mensagem">
            <span id="mensagemTexto"></span>
            <button id="botaoSim" onclick="confirmarAcao(true)">Sim</button>
            <button id="botaoNao" onclick="confirmarAcao(false)">N√£o</button>
            </div>
        </div>

        <script> // Filtro da Tabela
            function aplicarFiltro(filtro) {
                const linhas = document.querySelectorAll('#tabelaDoadores tbody tr');

                linhas.forEach((linha) => {
                    const textoLinha = linha.textContent.toLowerCase().trim();

                    // Verifica se o texto da linha inclui o valor do filtro
                    linha.style.display = textoLinha.includes(filtro) ? '' : 'none';
                });
            };

            // Adiciona o evento de input ao elemento com ID 'filtro'
            document.getElementById('filtro').addEventListener('input', function () {
                const filtro = this.value.toLowerCase();

                // Chama a fun√ß√£o de filtro, passando o texto do filtro
                aplicarFiltro(filtro);
            });
        </script>

    </div>
</body>
</html>